name: Daily Profile Stats Update

on:
  schedule:
    - cron: '0 22 * * *'  # Daily at 10 PM UTC
  workflow_dispatch:  # Manual trigger for testing
  push:
    branches: [ main ]
    paths: [ 'scripts/update_stats.py' ]

# Repository permissions
permissions:
  contents: write
  actions: read

jobs:
  update-daily-stats:
    runs-on: ubuntu-latest
    name: 🌙 Nightly Coding Stats Update
    
    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: 🐍 Setup Python Environment
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: 📦 Create Requirements File
      run: |
        cat > requirements.txt << 'EOF'
        requests>=2.31.0
        beautifulsoup4>=4.12.0
        lxml>=4.9.0
        EOF
        
    - name: ⚡ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: 📁 Prepare Data Directory
      run: mkdir -p data
        
    - name: 🚀 Update Coding Platform Stats
      run: |
        echo "🌙 Starting nightly stats update at 10 PM UTC..."
        python scripts/update_stats.py
      continue-on-error: true
      
    - name: 📊 Verify Updated Data
      run: |
        echo "📈 Generated stats files:"
        ls -la data/ 2>/dev/null || echo "⚠️ No data directory found"
        
    - name: 🔍 Check for Changes
      id: check-changes
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "✅ Daily progress detected"
          git status --short
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "ℹ️ No changes in daily progress"
        fi
        
    - name: 📈 Display Daily Summary
      if: always()
      run: |
        echo "🎯 Daily Coding Progress Summary"
        echo "=================================="
        
        # LeetCode
        if [ -f "data/leetcode_stats.json" ]; then
          LEETCODE_TOTAL=$(cat data/leetcode_stats.json | python -c "import sys, json; print(json.load(sys.stdin).get('solved_problems', {}).get('total', 0))" 2>/dev/null || echo "0")
          echo "🔥 LeetCode: $LEETCODE_TOTAL problems solved"
        fi
        
        # GeeksforGeeks  
        if [ -f "data/geeksforgeeks_stats.json" ]; then
          GFG_TOTAL=$(cat data/geeksforgeeks_stats.json | python -c "import sys, json; print(json.load(sys.stdin).get('problems_solved', 0))" 2>/dev/null || echo "0")
          echo "🚀 GeeksforGeeks: $GFG_TOTAL problems solved"
        fi
        
        # HackerRank
        if [ -f "data/hackerrank_stats.json" ]; then
          HR_BADGES=$(cat data/hackerrank_stats.json | python -c "import sys, json; print(json.load(sys.stdin).get('badges', 0))" 2>/dev/null || echo "0")
          echo "⭐ HackerRank: $HR_BADGES badges earned"
        fi
        
        echo "🕙 Update completed at: $(date +'%Y-%m-%d %H:%M UTC')"
        
    - name: 💾 Commit Daily Progress
      if: steps.check-changes.outputs.changes == 'true'
      run: |
        git config --local user.email "sbbalaganesh2004@gmail.com"
        git config --local user.name "Balaganesh.S.B"
        git add -A
        
        # Create daily commit message
        COMMIT_MSG="🌙 Daily coding progress update - $(date +'%Y-%m-%d %H:%M UTC')

        📊 Nightly Stats Summary:
        $(if [ -f data/leetcode_stats.json ]; then echo "🔥 LeetCode: $(cat data/leetcode_stats.json | python -c 'import sys, json; print(json.load(sys.stdin).get("solved_problems", {}).get("total", 0))' 2>/dev/null || echo '0') problems"; fi)
        $(if [ -f data/geeksforgeeks_stats.json ]; then echo "🚀 GeeksforGeeks: $(cat data/geeksforgeeks_stats.json | python -c 'import sys, json; print(json.load(sys.stdin).get("problems_solved", 0))' 2>/dev/null || echo '0') problems"; fi)  
        $(if [ -f data/hackerrank_stats.json ]; then echo "⭐ HackerRank: $(cat data/hackerrank_stats.json | python -c 'import sys, json; print(json.load(sys.stdin).get("badges", 0))' 2>/dev/null || echo '0') badges"; fi)
        
        🤖 Auto-updated at 10 PM UTC via GitHub Actions"
        
        git commit -m "$COMMIT_MSG"
        git push origin main
        
    - name: 📋 Generate Summary Report
      if: always()
      run: |
        echo "# 🌙 Daily Coding Progress Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**📅 Date:** $(date +'%Y-%m-%d')" >> $GITHUB_STEP_SUMMARY
        echo "**🕙 Time:** $(date +'%H:%M UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## 📊 Platform Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| 🏆 Platform | 📈 Stats | 🎯 Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------------|----------|-----------|" >> $GITHUB_STEP_SUMMARY
        
        # LeetCode status
        if [ -f data/leetcode_stats.json ]; then
          LC_COUNT=$(cat data/leetcode_stats.json | python -c "import sys, json; data=json.load(sys.stdin); print(f\"{data.get('solved_problems', {}).get('total', 0)} problems\")" 2>/dev/null || echo "Data Error")
          echo "| 🔥 **LeetCode** | $LC_COUNT | ✅ Updated |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| 🔥 **LeetCode** | - | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # GeeksforGeeks status
        if [ -f data/geeksforgeeks_stats.json ]; then
          GFG_COUNT=$(cat data/geeksforgeeks_stats.json | python -c "import sys, json; data=json.load(sys.stdin); print(f\"{data.get('problems_solved', 0)} problems\")" 2>/dev/null || echo "Data Error")
          echo "| 🚀 **GeeksforGeeks** | $GFG_COUNT | ✅ Updated |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| 🚀 **GeeksforGeeks** | - | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # HackerRank status
        if [ -f data/hackerrank_stats.json ]; then
          HR_COUNT=$(cat data/hackerrank_stats.json | python -c "import sys, json; data=json.load(sys.stdin); print(f\"{data.get('badges', 0)} badges\")" 2>/dev/null || echo "Data Error")
          echo "| ⭐ **HackerRank** | $HR_COUNT | ✅ Updated |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ⭐ **HackerRank** | - | ❌ Failed |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## 🎯 Daily Highlights" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- 🌙 **Update Schedule:** Every night at 10 PM UTC" >> $GITHUB_STEP_SUMMARY
        echo "- 🔄 **Changes Detected:** $(if [ '${{ steps.check-changes.outputs.changes }}' = 'true' ]; then echo 'Yes - Profile Updated!'; else echo 'No changes today'; fi)" >> $GITHUB_STEP_SUMMARY
        echo "- 📊 **Platforms Monitored:** LeetCode, GeeksforGeeks, HackerRank" >> $GITHUB_STEP_SUMMARY
        echo "- ⏰ **Next Update:** Tomorrow at 10 PM UTC" >> $GITHUB_STEP_SUMMARY