name: Update Daily Coding Progress

on:
  schedule:
    - cron: '0 22 * * *'  # Daily at 10:00 PM UTC (adjust timezone as needed)
  workflow_dispatch:  # Manual trigger
  push:
    branches: [ main ]
    paths: [ 'scripts/update_daily_stats.py' ]

# Grant permissions to write to repository
permissions:
  contents: write
  actions: read
  pull-requests: write

jobs:
  update-daily-progress:
    runs-on: ubuntu-latest
    name: Update Daily Coding Progress & Stats
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Create requirements.txt if not exists
      run: |
        if [ ! -f requirements.txt ]; then
          echo "Creating requirements.txt..."
          cat > requirements.txt << EOF
        requests>=2.31.0
        beautifulsoup4>=4.12.0
        lxml>=4.9.0
        python-dateutil>=2.8.0
        EOF
        fi
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Create data directories
      run: |
        mkdir -p data/daily_progress
        mkdir -p data/platform_stats
        
    - name: Update daily coding progress
      run: |
        echo "ðŸŒ™ Starting daily stats update at 10:00 PM..."
        python scripts/update_daily_stats.py
      continue-on-error: true
      
    - name: Verify data files
      run: |
        echo "ðŸ“ Checking generated data files:"
        ls -la data/daily_progress/ || echo "No daily progress directory"
        ls -la data/platform_stats/ || echo "No platform stats directory"
        
    - name: Check for changes
      id: verify-changed-files
      run: |
        echo "ðŸ” Checking for changes..."
        git diff --name-only
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "âœ… Changes detected"
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ No changes detected"
        fi
        
    - name: Display today's progress
      if: always()
      run: |
        TODAY=$(date +'%Y-%m-%d')
        echo "ðŸ“Š Today's Progress Summary ($TODAY):"
        echo "=================================="
        
        if [ -f "data/daily_progress/${TODAY}.json" ]; then
          echo "ðŸ“„ Daily Progress:"
          cat "data/daily_progress/${TODAY}.json" | python -m json.tool || echo "Invalid JSON"
        fi
        
        echo ""
        echo "ðŸ“ˆ Platform Stats:"
        for file in data/platform_stats/*.json; do
          if [ -f "$file" ]; then
            echo "ðŸ“„ $(basename "$file"):"
            cat "$file" | python -m json.tool || echo "Invalid JSON in $file"
            echo ""
          fi
        done
        
    - name: Commit and push changes
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --local user.email "sbbalaganesh2004@gmail.com"
        git config --local user.name "Balaganesh.S.B"
        git add -A
        
        TODAY=$(date +'%Y-%m-%d')
        CURRENT_TIME=$(date +'%H:%M:%S UTC')
        
        # Create detailed commit message
        COMMIT_MSG="ðŸŒ™ Daily progress update - $TODAY at $CURRENT_TIME

        ðŸ“Š Updated at 10:00 PM daily schedule:
        - ðŸ”¥ LeetCode: $([ -f data/platform_stats/leetcode_stats.json ] && echo "âœ…" || echo "âŒ")
        - ðŸš€ GeeksforGeeks: $([ -f data/platform_stats/geeksforgeeks_stats.json ] && echo "âœ…" || echo "âŒ")  
        - â­ HackerRank: $([ -f data/platform_stats/hackerrank_stats.json ] && echo "âœ…" || echo "âŒ")
        - ðŸ“… Daily Progress: $([ -f data/daily_progress/$TODAY.json ] && echo "âœ…" || echo "âŒ")
        
        ðŸŒ™ Automated nightly update via GitHub Actions
        ðŸ“ˆ Tracking daily progress and cumulative stats"
        
        git commit -m "$COMMIT_MSG"
        git push origin main
        
    - name: Create daily summary
      if: always()
      run: |
        TODAY=$(date +'%Y-%m-%d')
        
        echo "## ðŸŒ™ Daily Progress Update - $TODAY" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Platform | Today's Status | Total Progress |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|----------------|----------------|" >> $GITHUB_STEP_SUMMARY
        
        # Check daily progress
        if [ -f "data/daily_progress/$TODAY.json" ]; then
          DAILY_TOTAL=$(cat "data/daily_progress/$TODAY.json" | python -c "import sys, json; data=json.load(sys.stdin); print(data.get('problems_solved_today', 0))" 2>/dev/null || echo "0")
          echo "| ðŸ“… **Daily Progress** | âœ… Tracked | $DAILY_TOTAL problems today |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ðŸ“… **Daily Progress** | âŒ Not tracked | - |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Check each platform
        if [ -f data/platform_stats/leetcode_stats.json ]; then
          LEETCODE_COUNT=$(cat data/platform_stats/leetcode_stats.json | python -c "import sys, json; data=json.load(sys.stdin); print(data.get('solved_problems', {}).get('total', 0))" 2>/dev/null || echo "0")
          echo "| ðŸ”¥ LeetCode | âœ… Updated | $LEETCODE_COUNT total |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ðŸ”¥ LeetCode | âŒ Failed | - |" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f data/platform_stats/geeksforgeeks_stats.json ]; then
          GFG_COUNT=$(cat data/platform_stats/geeksforgeeks_stats.json | python -c "import sys, json; data=json.load(sys.stdin); print(data.get('problems_solved', 0))" 2>/dev/null || echo "0")
          echo "| ðŸš€ GeeksforGeeks | âœ… Updated | $GFG_COUNT total |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ðŸš€ GeeksforGeeks | âŒ Failed | - |" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f data/platform_stats/hackerrank_stats.json ]; then
          HR_COUNT=$(cat data/platform_stats/hackerrank_stats.json | python -c "import sys, json; data=json.load(sys.stdin); print(data.get('badges', 0))" 2>/dev/null || echo "0")
          echo "| â­ HackerRank | âœ… Updated | $HR_COUNT badges |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| â­ HackerRank | âŒ Failed | - |" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŒ™ **Update Time:** $(date +'%Y-%m-%d %H:%M:%S UTC') (Scheduled: 10:00 PM daily)" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”„ **Changes:** $(if [ '${{ steps.verify-changed-files.outputs.changed }}' = 'true' ]; then echo 'Yes - Profile Updated'; else echo 'No changes needed'; fi)" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ˆ **Daily Tracking:** Individual day progress + cumulative stats" >> $GITHUB_STEP_SUMMARY